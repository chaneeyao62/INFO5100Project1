<!DOCTYPE html>
<head>
  <title>Map</title>
  <script src="https://d3js.org/d3.v4.min.js"></script>
  <script src="https://d3js.org/d3-geo-projection.v1.min.js"></script>
  <style>
  #LaptopMap {border: solid #ccc 1px;}
  </style>
</head>
<body>
  <svg id="LaptopMap" height="600" width="1000">
  </svg>
  <svg id="plot3" height="1000" width="800"></svg>
  <script>
  var worldMap;
  var priceIndex;
  var mappedData;

  var parseRow = function(row) {
    row.Rank = Number(row.Rank);
    row.iPhone = Number(row.iPhone);
    row.Android = Number(row.Android);
    row.MacBook = Number(row.MacBook);
    row["Windows Powered"] = Number(row["Windows Powered"]);
    row["PS4"] = Number(row["PS4"]);
    row["Xbox one"] = Number(row["Xbox one"]);
    row["iPad mini"] = Number(row["iPad mini"]);
    row["Samsung tablet"] = Number(row["Samsung tablet"]);
    row["40 inch smart TV"] = Number(row["40 inch smart TV"]);
    row["Apple Watch"] = Number(row["Apple Watch"]);
    row["Brand headphone"] = Number(row["Brand headphone"]);
    row["hard drive 2TB"] = Number(row["hard drive 2TB"]);
    row["Portable charger"] = Number(row["Portable charger"]);
    row.Printer = Number(row.Printer);
    return row;
  }

  d3.queue()
  .defer(d3.json, "countries.geo.json")
  .defer(d3.csv, "TechnologyIndex.csv", parseRow)
  .await(function (error, rawMap, rawData) {
    worldMap = rawMap;
    priceIndex = rawData;
    mappedData = d3.map(priceIndex, function(d) {return d.Country;});
    showMap();
  });
  var svg_map = d3.select("#LaptopMap");
  var projection = d3.geoRobinson().scale(100);
  var pathGenerator = d3.geoPath().projection(projection);


  function showMap(){
    // Show the map for MacBooks
    var macExtent = d3.extent(priceIndex, function(d) {return d.MacBook;});
    var mapColors = ['#e5f5f9','#99d8c9','#2ca25f'];
    var macScale = d3.scaleLog().domain(macExtent).range(mapColors);
    projection.fitExtent([[0,0], [svg_map.attr("width")/2, svg_map.attr("height")]], worldMap);
    var paths1 = svg_map.selectAll("path.mac").data(worldMap.features);
    paths1.enter().append("path").attr("class", "mac")
    .merge(paths1)
    .attr("d", function (country){
      var rowData = mappedData.get(country.properties.name);
      return pathGenerator(country);})
    .attr("fill", function(country) {
      var rowData = mappedData.get(country.properties.name);
      if(rowData){
        return macScale(rowData.MacBook);
      }
    });

    // Show the map for Windows Books
    var winExtent = d3.extent(priceIndex, function(d) {return d["Windows Powered"];});
    var winScale = d3.scaleLinear().domain(winExtent).range(mapColors);
    projection.fitExtent([[svg_map.attr("width")/2,0], [svg_map.attr("width"), svg_map.attr("height")]], worldMap);
    var paths2 = svg_map.selectAll("path.win").data(worldMap.features);
    paths2.enter().append("path").attr("class", "win")
    .merge(paths2)
    .attr("d", function (country){
      var rowData = mappedData.get(country.properties.name);
      return pathGenerator(country);})
    .attr("fill", function(country) {
      var rowData = mappedData.get(country.properties.name);
      if(rowData){
        return winScale(rowData["Windows Powered"]);
      }
    });

  }
  // Some countries (USA, UK, Hong Kong, Uruaguay, Singapore)
  // have different names in csv & geojson, match them
  function cleanMapData(){
    worldMap.features.forEach

  }


  </script>
</body>
